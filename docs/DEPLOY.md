# Деплой на сервер (Docker)

Чтобы на сервере подхватывались **последние изменения** (меню, шифрование, дашборд и т.д.), сборка и запуск должны идти из актуального кода.

## Важно: где собирается образ

- Если образ **собирается на сервере** — ниже шаги для сервера.
- Если образ **собирается в CI и пушится в registry** — на сервере делаете только `docker compose pull` и `docker compose up -d`; тогда свежая версия зависит от того, что CI собрал и запушул последним.

## Шаги на сервере (сборка на сервере)

Выполняйте в каталоге с клоном репозитория (где лежат `Dockerfile` и `docker-compose.yml`).

### 1. Обновить код

```bash
git fetch origin
git pull origin master
```

Убедитесь, что `git status` и `git log -1` показывают ожидаемый коммит.

### 2. Собрать образ без кэша

```bash
docker compose build --no-cache
```

Так Docker не использует старые слои; в образ попадает текущее содержимое репозитория.

### 3. Пересоздать контейнер

```bash
docker compose up -d --force-recreate
```

`--force-recreate` заставляет поднять контейнер заново из только что собранного образа.

### 4. Проверить, что крутится новая версия

Откройте в браузере (или через `curl`):

- **Время сборки образа:**  
  `https://ваш-домен/build-info.json`  
  Должна быть дата/время последней сборки (по UTC).

- **Конфиг (секрет и webhook):**  
  `https://ваш-домен/config-status.json`  
  Для HMAC должно быть `"secret_set": true`.

После деплоя сделайте **жёсткое обновление** страницы, чтобы не использовать кэш браузера:

- Windows/Linux: `Ctrl+Shift+R` или `Ctrl+F5`
- Mac: `Cmd+Shift+R`

Либо откройте сайт в режиме инкогнито.

## Если всё равно видите старую версию

1. **Проверьте `build-info.json`**  
   Если дата в файле свежая, но интерфейс старый — значит, кэширует браузер или CDN/прокси. Очистите кэш или откройте в инкогнито.

2. **Проверьте, какой образ реально используется:**
   ```bash
   docker compose images
   docker compose ps
   ```
   Убедитесь, что контейнер создан недавно (после вашего `up -d --force-recreate`).

3. **Проверьте, что сборка была из нужной папки:**  
   Запуск `docker compose build` должен быть из каталога, где вы делали `git pull`. Иначе в образ мог попасть старый код.

4. **Если используете registry:**  
   На сервере вы подтягиваете образ из registry. Новая версия появится только после того, как CI (или вы вручную) соберёт образ из актуального кода и сделает `docker push`.

## Краткая последовательность (копировать целиком)

```bash
cd /path/to/A1_client
git pull origin master
docker compose build --no-cache
docker compose up -d --force-recreate
```

После этого откройте `https://ваш-домен/build-info.json` и обновите страницу приложения с `Ctrl+Shift+R`.
